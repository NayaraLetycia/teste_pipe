name: CI - Hello

on:
  push:

jobs:
  hello:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        environment: [ci, staging, prod]

    env:
      APP_NAME: teste_pipe
      ENVIRONMENT: ${{ matrix.environment }}

    steps:
      - name: Checkout do repositório
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        uses: actions/checkout@v4

      - name: Verificações básicas do repositório
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        run: |
          test -f README.md || (echo "ERRO: README.md não existe" && exit 1)
          echo "OK: README.md existe"

      - name: Listar arquivos do repo
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        run: |
          pwd
          ls -la

      - name: Usando variáveis de ambiente
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        run: |
          echo "Aplicação: $APP_NAME"
          echo "Ambiente: $ENVIRONMENT"
          echo "Branch: $GITHUB_REF_NAME"

      - name: Usando secret sem vazar
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        env:
          MY_SECRET: ${{ secrets.MY_SECRET }}
        run: |
          if [ -z "$MY_SECRET" ]; then
            echo "Erro: Secret não foi carregada"
            exit 1
          fi
          echo "OK: secret carregada"

      - name: Gerar relatório
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        run: |
          mkdir -p out
          echo "Relatório do pipeline" > out/relatorio.txt
          echo "Repo: $GITHUB_REPOSITORY" >> out/relatorio.txt
          echo "Branch: $GITHUB_REF_NAME" >> out/relatorio.txt
          echo "SHA: $GITHUB_SHA" >> out/relatorio.txt
          echo "Data (UTC): $(date -u)" >> out/relatorio.txt
          echo "ENVIRONMENT: $ENVIRONMENT" >> out/relatorio.txt
          ls -la out
          echo "----"
          cat out/relatorio.txt

      - name: Upload do artefato (relatório)
        if: ${{ matrix.environment != 'prod' || github.ref_name == 'main' }}
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-${{ matrix.environment }}
          path: out/relatorio.txt

      - name: Step exclusivo de PROD
        if: ${{ matrix.environment == 'prod' && github.ref_name == 'main' }}
        run: |
          echo "Rodando somente em PROD"
          echo "ENVIRONMENT atual: $ENVIRONMENT"
